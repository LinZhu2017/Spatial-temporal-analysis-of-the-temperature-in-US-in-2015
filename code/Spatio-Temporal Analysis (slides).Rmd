---
title: "Spatio-Temporal Analysis of America temperature in 2015"
author: "Zhu Lin"
output:
  ioslides_presentation:
   widescreen: true
   transition: "faster"
  slidy_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=4, fig.height=2, fig.align = "center", warning=FALSE, message=FALSE)
```

## Introduction
Climate change and potential global warming have become the significant issue of the day, monitoring temperatures across the region, therefore, is becoming increasingly important in response to weather-related disasters.

The data files US_weather_2015 and weather_stations correspondingly contain temperature of the United States at different stations and and their locations (marked by longitude, latitude and elevation) from January 1 to December 31, 2015, a period of 365 days. 

## Data description
The following packages are used in this project. 

```{r echo=TRUE}
library(readr)
library(dplyr)
library(ggplot2)
library(plotly)
library(maps)
library(mapdata) 
library(maptools)
library(graphics)
library(gstat)
library(sp)
library(viridis)
library(fields)
```

## Data description
Read two data files US_weather_2015 and weather_stations

```{r echo=TRUE}
load("weather_data.RData")
load("weather_stations.RData")
```

## Data description

Dataframe weather has five variables: stn, year, month, day and temp.
```{r echo=TRUE}
head(weather_data)
```

## Data description

Dataframe loc has seven variables: stn, name, country, state, lat, lon and elev.
```{r echo=TRUE}
head(weather_stations)
```

## Monthly data 
We can get a rough idea of the monthly temperature in the United States from the histogram and boxplot.

<img src = "~/UStemperature/results/monthly_box.html", height="42",width="42">

```{r, echo=FALSE, out.width="25%"}
htmltools::includeHTML("~/UStemperature/results/monthly_hist.html")
```

## Monthly data 
We can get a rough idea of the monthly temperature in the United States from the histogram and boxplot.

<img src = "~/UStemperature/results/monthly_box.html", height="42" width="42">


```{r, echo=FALSE, out.width="25%"}
htmltools::includeHTML("~/UStemperature/results/monthly_box.html")
```

## Data of Jan 1, 2015
To familiarize ourselves with the geography of the dataset, we will initially ignore the temporal component of the dataset and examine the spatial distribution of temperatures on a single day. Take day 1 as an example, therefore, we extract data of January 1, 2015.

```{r include=FALSE}
load("~/UStemperature/results/day1.RData")
```

```{r echo=TRUE}
## Extract day 1's data and sort it
head(day1)
```

## Temperature distribution image of Jan 1, 2015
Since the temperature points are discrete with respect to the whole space (in the longitude-latitude-axis matrix, only 0.02% of elements are not NA), it is not available to show the United States temperatures by using the image.plot command in the fields package. In this case, we introduce the following method to plot the discrete points' temperature distribution image.

## Temperature distribution image of Jan 1, 2015

```{r, echo=FALSE, out.width="30%"}
htmltools::includeHTML("~/UStemperature/results/day1.html")
```

## Temperature distribution image of Jan 1, 2015

A pronounced temperature gradient is visible from highs of over 85.6 Fahrenheit in the north of the study area which is near to the equator to a low of -14.7 Fahrenheit towards the southern boundary. This is not only indicative of spatial correlation in the dataset, but it also shows that the data are not stationary, as the mean temperature must vary strongly with latitude. 

According to the temperature distribution image of January 1, 2015, we can find that on January 1 in 2015, the temperature in most parts of the United States was concentrated at 30 Fahrenheit and extreme temperatures only account for a small proportion.

## Mean and variance of US temperature by latitude on Jan 1 in 2015
![](m_lat_day1.pdf)
![](var_lat_day1.pdf)

## Mean and variance of US temperature by longitude on Jan 1 in 2015

```{r,echo=FALSE, out.width='.49\\linewidth', fig.width=3, fig.height=3,fig.show='hold',fig.align='center'}
knitr::include_graphics("~/UStemperature/results/m_lon_day1.pdf")
knitr::include_graphics("~/UStemperature/results/var_lon_day1.pdf")
```

## Mean and variance of US temperature by elevation on Jan 1 in 2015

```{r,echo=FALSE, out.width='.49\\linewidth', fig.width=3, fig.height=3,fig.show='hold',fig.align='center'}
knitr::include_graphics("~/UStemperature/results/m_elev_day1.pdf")
knitr::include_graphics("~/UStemperature/results/var_elev_day1.pdf")
```

## Define train data and test data
Longitude, latitude, altitude and corresponding temperature were extracted from the data "day1", 80% of which was training set and the rest was test set.

```{r include=FALSE}
load("~/UStemperature/results/X_new.RData")
load("~/UStemperature/results/Y_new.RData")
load("~/UStemperature/results/Z_new.RData")
```

```{r echo=TRUE}
set.seed(123)
index = sample(nrow(Y_new),nrow(Y_new)*0.8)
train_X = X_new[index,]
test_X = X_new[-index,]
train_y = as.matrix(Y_new)[index]
test_y = as.matrix(Y_new)[-index]
train_Z = Z_new[index]
test_Z = Z_new[-index]
```

## Model fitting 

```{r}
## parameter estimation
#(fields use great circle distances, approxiamte the earth by a ball)
library(fields)
par_est = spatialProcess(train_X,train_y,Z=train_Z,
                         cov.args = list(Covariance = "Matern",smoothness = 1))
sigma = as.numeric(par_est$sigma.MLE)     # nugget variance (sigma^2)  2.087864
rho = as.numeric(par_est$rho.MLE)         # process variance (rho)   131.4304
theta = as.numeric(par_est$theta.MLE)     # range parameter (theta)  3.871543
```

## Prediction by Matern model

```{r}
library(gstat)
library(sp)
g2 = gstat(formula = trainData$train_y~1, 
           data = trainData, model = vgm(rho,"Mat",theta,sigma^2))
pre = predict(g2, pre_loc)
test_y_hat3 = pre$var1.pred
MSE3 = mean((test_y_hat3-test_y)^2)  # 9.214505
```

## Model evaluation
```{r}
plot(par_est)  
```

```{r,echo=FALSE, out.width='.49\\linewidth', fig.width=3, fig.height=3,fig.show='hold',fig.align='center'}
knitr::include_graphics("~/UStemperature/results/obs.vs.pre.day.pdf")
knitr::include_graphics("~/UStemperature/results/res.vs.pre.day.pdf")
```

## Construct prediction data
```{r}
## Create testing data by meshgrid
lon_num = 50
lat_num = 50
n_test = lon_num * lat_num
lon_seq = seq(-125,-65,length.out=lon_num)
lat_seq = seq(25,50,length.out=lat_num)

count = 0
test_X = matrix(0, nrow=n_test, ncol=2)
for(i in lon_seq){
  for(j in lat_seq){
    count = count + 1
    test_X[count,1] = i
    test_X[count,2] = j
  }
}

test_X = as.data.frame(test_X)
colnames(test_X) = c("lon","lat")
```

## Plot of Krigged temperature on Jan 1, 2015
```{r}
df <- expand.grid(x = test_X$lon, y = test_X$lat)
df$z <- test_y_hat
colnames(df)=c("lon","lat","temp")

library(viridis)
ggplot(df, aes(lon, lat,fill = temp)) + 
  geom_raster(interpolate = F) + 
  scale_fill_continuous(type="viridis",alpha=0.05) +
  geom_polygon(data = statesMap, aes(x=long, y = lat, group = group), color = "black",fill="grey", alpha=0) +
  labs(x = "lon",y = "lat", title = 'Krigged US temp (Fahrenheit) on Jan 1st, 2015') + 
  theme(plot.title = element_text(hjust = 0.4))
```

## Plot of Krigged temperature on Jan 1, 2015
```{r echo=FALSE}
df <- expand.grid(x = test_X$lon, y = test_X$lat)
df$z <- test_y_hat
colnames(df)=c("lon","lat","temp")

library(viridis)
ggplot(df, aes(lon, lat,fill = temp)) + 
  geom_raster(interpolate = F) + 
  scale_fill_continuous(type="viridis",alpha=0.05) +
  geom_polygon(data = statesMap, aes(x=long, y = lat, group = group), color = "black",fill="grey", alpha=0) +
  labs(x = "lon",y = "lat", title = 'Krigged US temp (Fahrenheit) on Jan 1st, 2015') + 
  theme(plot.title = element_text(hjust = 0.4))
```